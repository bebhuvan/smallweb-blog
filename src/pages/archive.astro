---
import Base from '../layouts/Base.astro';
import blogsData from '../../data/blogs.json';
import postsData from '../../data/cache/posts.json';

const blogs = blogsData.blogs;
const posts = postsData.posts;

const blogMap = new Map(blogs.map((b) => [b.id, b]));

const enrichedPosts = posts.map((post) => {
  const blog = blogMap.get(post.blogId);
  const category = blog?.categories?.[0];
  return {
    ...post,
    blogName: blog?.name || '',
    category: category || 'tech',
  };
});

// Group posts by month
type PostsByMonth = { [key: string]: typeof enrichedPosts };
const postsByMonth: PostsByMonth = {};

enrichedPosts.forEach((post) => {
  const date = new Date(post.date);
  const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
  if (!postsByMonth[monthKey]) {
    postsByMonth[monthKey] = [];
  }
  postsByMonth[monthKey].push(post);
});

// Sort months (newest first)
const sortedMonths = Object.keys(postsByMonth).sort((a, b) => {
  return new Date(b).getTime() - new Date(a).getTime();
});

function formatShortDate(dateStr: string) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<Base title="Archive — The Small Web">
  <header class="site-header">
    <div class="header-inner">
      <a href="/" class="logo">The Small Web</a>
      <nav class="header-nav">
        <a href="/">Home</a>
        <a href="/feed">Feed</a>
        <a href="/archive" class="active">Archive</a>
        <a href="/blogs">Blogs</a>
        <a href="/about">About</a>
        <a href="https://buymeacoffee.com/bebhuvan" target="_blank" rel="noopener" class="nav-support">Support</a>
        <button class="theme-toggle" id="theme-toggle">Dark mode</button>
      </nav>
    </div>
  </header>

  <nav class="category-nav">
    <ul>
      <li><a href="/archive" class="active">All</a></li>
      <li><a href="/category/tech"><span class="cat-dot tech"></span>Tech</a></li>
      <li><a href="/category/design"><span class="cat-dot design"></span>Design</a></li>
      <li><a href="/category/life"><span class="cat-dot life"></span>Life</a></li>
      <li><a href="/category/culture"><span class="cat-dot culture"></span>Culture</a></li>
      <li><a href="/category/finance"><span class="cat-dot finance"></span>Finance</a></li>
    </ul>
  </nav>

  <main style="max-width: 900px; margin: 0 auto; padding: 3rem 2rem;">
    <div class="page-header">
      <h1 class="page-title">Archive</h1>
      <p class="page-subtitle">Every post from every blog, searchable</p>
    </div>

    <div class="search-container">
      <div class="search-box">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input type="text" class="search-input" id="search-input" placeholder="Search posts, authors, topics...">
      </div>
    </div>

    <div id="archive-content">
      {sortedMonths.map((month) => (
        <section class="archive-month" data-month={month}>
          <h2 class="month-header">{month}</h2>
          <div class="archive-list">
            {postsByMonth[month].map((post) => (
              <a
                href={post.link}
                target="_blank"
                rel="noopener noreferrer"
                class="archive-item"
                data-title={post.title.toLowerCase()}
                data-author={post.blogName.toLowerCase()}
                data-category={post.category}
              >
                <span class="archive-date">{formatShortDate(post.date)}</span>
                <div class="archive-content">
                  <h3 class="archive-title">{post.title}</h3>
                  <p class="archive-meta">{post.blogName}</p>
                </div>
                <span class={`archive-category ${post.category}`}>{post.category.charAt(0).toUpperCase() + post.category.slice(1)}</span>
              </a>
            ))}
          </div>
        </section>
      ))}
    </div>

    <div id="no-results" style="display: none; text-align: center; padding: 3rem; color: var(--text-muted);">
      <p style="font-size: 1.1rem;">No posts found matching your search.</p>
    </div>
  </main>

  <footer class="site-footer">
    <p class="footer-text">A curated feed of indie blogs · <a href="/rss.xml" style="color: var(--accent);">RSS</a> · <a href="https://github.com/bebhuvan/smallweb-blog" target="_blank" rel="noopener" style="color: var(--accent);">GitHub</a></p>
  </footer>

  <script>
    const toggle = document.getElementById('theme-toggle');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const archiveContent = document.getElementById('archive-content');
    const noResults = document.getElementById('no-results');

    function updateButtonText() {
      if (toggle) {
        toggle.textContent = document.documentElement.classList.contains('dark') ? 'Light mode' : 'Dark mode';
      }
    }

    toggle?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.theme = isDark ? 'dark' : 'light';
      updateButtonText();
    });

    updateButtonText();

    // Search functionality
    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
      const items = document.querySelectorAll('.archive-item');
      const months = document.querySelectorAll('.archive-month');
      let totalVisible = 0;

      items.forEach((item) => {
        const title = item.getAttribute('data-title') || '';
        const author = item.getAttribute('data-author') || '';
        const category = item.getAttribute('data-category') || '';

        const matches = !query ||
          title.includes(query) ||
          author.includes(query) ||
          category.includes(query);

        (item as HTMLElement).style.display = matches ? '' : 'none';
        if (matches) totalVisible++;
      });

      // Hide empty months
      months.forEach((month) => {
        const visibleItems = month.querySelectorAll('.archive-item[style=""], .archive-item:not([style])');
        let hasVisible = false;
        visibleItems.forEach((item) => {
          if ((item as HTMLElement).style.display !== 'none') {
            hasVisible = true;
          }
        });

        const monthItems = month.querySelectorAll('.archive-item');
        let monthHasVisible = false;
        monthItems.forEach((item) => {
          if ((item as HTMLElement).style.display !== 'none') {
            monthHasVisible = true;
          }
        });

        (month as HTMLElement).style.display = monthHasVisible ? '' : 'none';
      });

      // Show/hide no results message
      if (noResults) {
        noResults.style.display = totalVisible === 0 && query ? 'block' : 'none';
      }
    });
  </script>
</Base>
