---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import { getBlogMap, getBlogs, getEnrichedPosts } from '../lib/site-data';
import { pickFeaturedPost } from '../lib/posts';
import { formatDate } from '../lib/dates';

const blogs = getBlogs();
const blogMap = getBlogMap(blogs);
const enrichedPosts = getEnrichedPosts({ blogs, blogMap });

const { featured: featuredPost, remaining: remainingPosts } = pickFeaturedPost(enrichedPosts, blogMap, {
  minExcerptLength: 80,
});

---

<Base title="Feed — The Small Web" description="The latest posts from indie blogs curated by The Small Web. A chronological feed of independent writing.">
  <ThemeToggle />

  <div class="page">
    <Header currentPath="/feed" />

    <main class="feed-main">
      <div class="editorial-header">
        <h1 class="editorial-title">The Feed</h1>
        <p class="editorial-sub">All posts, as they come in</p>
        <hr class="editorial-rule">
      </div>

      <div class="editorial-stats">
        <span><strong>{enrichedPosts.length}</strong> posts</span>
        <span><strong>{blogs.length}</strong> blogs</span>
      </div>

      {featuredPost && (
        <a href={featuredPost.link} target="_blank" rel="noopener noreferrer" class="asym-featured" style="margin-top: 1.5rem;">
          <span class={`lead-stamp ${featuredPost.category}`}>{featuredPost.category}</span>
          <h2 class="asym-featured-title">{featuredPost.title}</h2>
          <p class="asym-featured-meta">{featuredPost.blogName} · {formatDate(featuredPost.date)}</p>
          {featuredPost.excerpt && (
            <p class="asym-featured-excerpt">{featuredPost.excerpt}</p>
          )}
        </a>
      )}

      <div class="cut">✂</div>

      <div class="feed-list">
        {remainingPosts.map((post) => (
          <a
            href={post.link}
            target="_blank"
            rel="noopener noreferrer"
            class="feed-item"
          >
            <div class="feed-item-header">
              <span class="pick-cat">
                <span class="pick-cat-dot" style={`background: var(--${post.category})`}></span>
                <span style={`color: var(--${post.category})`}>{post.category}</span>
              </span>
              <span class="feed-time">{formatDate(post.date)}</span>
            </div>
            <h2 class="asym-item-title">{post.title}</h2>
            {post.excerpt && (
              <p class="feed-excerpt">{post.excerpt}</p>
            )}
            <p class="asym-item-meta">{post.blogName} · {new URL(post.blogUrl).hostname}</p>
          </a>
        ))}
      </div>

      <div class="feed-end">
        <p>You've reached the end</p>
        <a href="/">Back to home</a>
      </div>
    </main>

    <Footer />
  </div>
</Base>

<style>
  .feed-main {
    padding: 0 0 2rem;
    max-width: 680px;
    margin: 0 auto;
  }

  .feed-list {
    display: flex;
    flex-direction: column;
  }

  .feed-item {
    display: block;
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--rule);
    text-decoration: none;
    color: inherit;
    transition: padding-left 0.25s ease;
  }

  .feed-item:hover {
    padding-left: 3px;
  }

  .feed-item:hover .asym-item-title {
    color: var(--accent);
  }

  .feed-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .feed-time {
    font-size: 0.75rem;
    color: var(--ink-faint);
  }

  .feed-excerpt {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--ink-muted);
    margin-top: 0.3rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .feed-end {
    text-align: center;
    padding: 3rem 0;
    color: var(--ink-faint);
    font-size: 0.9rem;
  }

  .feed-end a {
    color: var(--accent);
    margin-top: 0.5rem;
    display: inline-block;
  }

  .feed-end a:hover {
    text-decoration: underline;
  }

  @media (max-width: 600px) {
    .feed-main {
      padding: 0 0 1.5rem;
    }

    .feed-item {
      padding: 1rem 0;
    }
  }
</style>
