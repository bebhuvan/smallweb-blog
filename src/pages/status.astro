---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import blogsData from '../../data/blogs.json';

let statusData = { lastUpdated: null, feeds: [], summary: { total: 0, healthy: 0, errors: 0 } };
try {
  statusData = await import('../../data/cache/status.json');
} catch (e) {
  // Status file doesn't exist yet
}

const blogs = blogsData.blogs;
const blogMap = new Map(blogs.map(b => [b.id, b]));
const hasErrors = (statusData.summary?.errors || 0) > 0;

const enrichedFeeds = statusData.feeds.map((feed: any) => {
  const blog = blogMap.get(feed.blogId);
  return {
    ...feed,
    name: blog?.name || feed.blogId,
    url: blog?.url || '',
    feedUrl: blog?.feed || '',
  };
}).sort((a: any, b: any) => {
  if (a.status !== b.status) return a.status === 'error' ? -1 : 1;
  return a.name.localeCompare(b.name);
});

function formatDate(dateStr: string) {
  if (!dateStr) return 'Never';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function getLatencyColor(ms: number) {
  if (ms < 1000) return 'var(--tech)';
  if (ms < 3000) return 'var(--life)';
  return 'var(--accent)';
}
---

<Base title="Feed Status â€” The Small Web" description="Monitor the health of all RSS feeds we're tracking.">
  <ThemeToggle />

  <div class="page">
    <Header currentPath="/status" showCategoryNav={false} />

    <main class="status-main">
      <div class="editorial-header">
        <h1 class="editorial-title">Feed Status</h1>
        <p class="editorial-sub">Monitoring {statusData.summary.total} RSS feeds</p>
        <hr class="editorial-rule">
      </div>

      {hasErrors && (
        <div class="status-alert">
          Some feeds failed in the latest refresh. The site continues to use the last successful data until the next refresh.
        </div>
      )}

      <div class="status-strip">
        <div class="status-strip-item">
          <div class="status-strip-value" style="color: var(--tech);">{statusData.summary.healthy}</div>
          <div class="status-strip-label">Healthy</div>
        </div>
        <div class="status-strip-item">
          <div class="status-strip-value" style="color: var(--accent);">{statusData.summary.errors}</div>
          <div class="status-strip-label">Errors</div>
        </div>
        <div class="status-strip-item">
          <div class="status-strip-value" style="font-size: 1rem; color: var(--ink-muted);">{formatDate(statusData.lastUpdated)}</div>
          <div class="status-strip-label">Last Updated</div>
        </div>
      </div>

      <section>
        <div class="section-head">
          <span class="section-head-text">All Feeds</span>
          <span class="section-head-count">{enrichedFeeds.length} feeds</span>
        </div>
        <div class="status-feed-list">
          {enrichedFeeds.map((feed: any) => (
            <div class="status-feed-row">
              <div class="status-dot" style={`background: ${feed.status === 'ok' ? 'var(--tech)' : 'var(--accent)'};`}></div>
              <div style="min-width: 0;">
                <div class="status-feed-name">{feed.name}</div>
                {feed.status === 'error' && feed.error && (
                  <div class="status-feed-error">{feed.error}</div>
                )}
              </div>
              <div class="status-feed-posts">{feed.postCount} posts</div>
              <div class="status-feed-latency" style={`color: ${getLatencyColor(feed.latencyMs)};`}>{feed.latencyMs}ms</div>
            </div>
          ))}
        </div>
      </section>

      <div class="status-note">
        Feeds are refreshed automatically twice daily via GitHub Actions.
      </div>
    </main>

    <Footer />
  </div>
</Base>

<style>
  .status-main {
    padding: 0 0 2rem;
  }

  .status-alert {
    margin: 1rem 0 1.25rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--accent);
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
    font-size: 0.9rem;
  }

  @media (max-width: 600px) {
    .status-main {
      padding: 0 0 1.5rem;
    }
  }
</style>
