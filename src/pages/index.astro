---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import blogsData from '../../data/blogs.json';
import postsData from '../../data/cache/posts.json';

const blogs = blogsData.blogs;
const posts = postsData.posts;

const blogMap = new Map(blogs.map((b) => [b.id, b]));

const enrichedPosts = posts.map((post) => {
  const blog = blogMap.get(post.blogId);
  const category = blog?.categories?.[0];
  return {
    ...post,
    blogName: blog?.name || '',
    blogUrl: blog?.url || '',
    category: category || 'tech',
  };
});

// Track used IDs
const usedIds = new Set<string>();

// Lead post: most recent
const leadPost = enrichedPosts[0];
if (leadPost) usedIds.add(leadPost.id);

// Also New: next 4 most recent posts after the lead
const alsoNew = enrichedPosts.filter(p => !usedIds.has(p.id)).slice(0, 4);
alsoNew.forEach(p => usedIds.add(p.id));

// Featured excerpt: pick the post with the longest excerpt from prose-heavy categories
const proseCategories = ['philosophy', 'culture', 'life', 'psychology', 'history'];
const excerptCandidates = enrichedPosts
  .filter(p => proseCategories.includes(p.category) && p.excerpt && p.excerpt.length > 80 && !usedIds.has(p.id))
  .sort((a, b) => (b.excerpt?.length || 0) - (a.excerpt?.length || 0));
const featuredExcerpt = excerptCandidates[0] || null;
if (featuredExcerpt) usedIds.add(featuredExcerpt.id);

// All categories: 1 featured + 4 list items each
const allCategories = ['tech', 'culture', 'life', 'design', 'economics', 'finance', 'history', 'philosophy', 'psychology', 'science'];
const categoryPosts = new Map<string, typeof enrichedPosts>();
for (const cat of allCategories) {
  const catPosts = enrichedPosts.filter(p => p.category === cat && !usedIds.has(p.id)).slice(0, 5);
  catPosts.forEach(p => usedIds.add(p.id));
  categoryPosts.set(cat, catPosts);
}

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  return 'Last month';
}

function getCatColor(cat: string) {
  return `var(--${cat})`;
}
---

<Base title="The Small Web — Curated Indie Blogs">
  <ThemeToggle />

  <div class="page">
    <Header currentPath="/" />

    <!-- Lead -->
    <section class="lead">
      {leadPost && (
        <a href={leadPost.link} target="_blank" rel="noopener noreferrer" class="lead-main">
          <span class={`lead-stamp ${leadPost.category}`}>{leadPost.category} · {formatDate(leadPost.date)}</span>
          <h2 class="lead-title">{leadPost.title}</h2>
          <p class="lead-byline">By <strong>{leadPost.blogName}</strong> · {new URL(leadPost.blogUrl).hostname}</p>
          {leadPost.excerpt && <p class="lead-excerpt">{leadPost.excerpt}</p>}
        </a>
      )}
      <div class="lead-side">
        <div class="lead-side-label">Also New</div>
        {alsoNew.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="pick">
            <div class="pick-cat" style={`color:${getCatColor(post.category)}`}>
              <span class="pick-cat-dot" style={`background:${getCatColor(post.category)}`}></span>
              {post.category}
            </div>
            <h4 class="pick-title">{post.title}</h4>
            <p class="pick-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
    </section>

    <!-- Cut -->
    <div class="cut">✂</div>

    {/* ── Row 1: Tech + Culture — standard ink-on-paper 2-col ── */}
    {(() => {
      const lp = categoryPosts.get('tech') || [];
      const rp = categoryPosts.get('culture') || [];
      return (
        <section class="category-pair">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--tech)"></span>
              <span class="category-col-name">Tech</span>
              <a href="/category/tech" class="category-col-link">All tech →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{lp[0].excerpt}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--culture)"></span>
              <span class="category-col-name">Culture</span>
              <a href="/category/culture" class="category-col-link">All culture →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{rp[0].excerpt}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    {/* ── Featured Excerpt ── */}
    {featuredExcerpt && (
      <>
        <div class="cut">✕</div>
        <a href={featuredExcerpt.link} target="_blank" rel="noopener noreferrer" class="pasted-quote">
          <div class="pasted-quote-bg"></div>
          <div class="pasted-quote-inner">
            <div class="pasted-quote-label">From the blogs</div>
            <p class="pasted-quote-text">{featuredExcerpt.excerpt!.slice(0, 280)}{featuredExcerpt.excerpt!.length > 280 ? '...' : ''}</p>
            <div class="pasted-quote-src">{featuredExcerpt.blogName} · {featuredExcerpt.title}</div>
          </div>
        </a>
      </>
    )}

    <div class="cut">✂</div>

    {/* ── Row 2: Life + Design — wash band ── */}
    {(() => {
      const lp = categoryPosts.get('life') || [];
      const rp = categoryPosts.get('design') || [];
      return (
        <section class="category-pair category-pair--wash" style="--pair-wash-l: var(--life-wash); --pair-wash-r: var(--design-wash)">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--life)"></span>
              <span class="category-col-name">Life</span>
              <a href="/category/life" class="category-col-link">All life →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{lp[0].excerpt}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--design)"></span>
              <span class="category-col-name">Design</span>
              <a href="/category/design" class="category-col-link">All design →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{rp[0].excerpt}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    <div class="cut">✕</div>

    {/* ── Row 3: Economics + Finance — plain ── */}
    {(() => {
      const lp = categoryPosts.get('economics') || [];
      const rp = categoryPosts.get('finance') || [];
      return (
        <section class="category-pair">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--economics)"></span>
              <span class="category-col-name">Economics</span>
              <a href="/category/economics" class="category-col-link">All economics →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{lp[0].excerpt}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--finance)"></span>
              <span class="category-col-name">Finance</span>
              <a href="/category/finance" class="category-col-link">All finance →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{rp[0].excerpt}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    <div class="cut">✂</div>

    {/* ── Row 4: History + Philosophy — wash band ── */}
    {(() => {
      const lp = categoryPosts.get('history') || [];
      const rp = categoryPosts.get('philosophy') || [];
      return (
        <section class="category-pair category-pair--wash" style="--pair-wash-l: var(--history-wash); --pair-wash-r: var(--philosophy-wash)">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--history)"></span>
              <span class="category-col-name">History</span>
              <a href="/category/history" class="category-col-link">All history →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{lp[0].excerpt}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--philosophy)"></span>
              <span class="category-col-name">Philosophy</span>
              <a href="/category/philosophy" class="category-col-link">All philosophy →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{rp[0].excerpt}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    <div class="cut">✕</div>

    {/* ── Row 5: Psychology + Science — plain ── */}
    {(() => {
      const lp = categoryPosts.get('psychology') || [];
      const rp = categoryPosts.get('science') || [];
      return (
        <section class="category-pair">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--psychology)"></span>
              <span class="category-col-name">Psychology</span>
              <a href="/category/psychology" class="category-col-link">All psychology →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{lp[0].excerpt}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--science)"></span>
              <span class="category-col-name">Science</span>
              <a href="/category/science" class="category-col-link">All science →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{rp[0].excerpt}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
                {post.excerpt && <p class="category-col-item-excerpt">{post.excerpt}</p>}
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    <Footer />
  </div>
</Base>
