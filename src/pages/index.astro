---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import { getBlogMap, getBlogs, getEnrichedPosts } from '../lib/site-data';
import { curateHomepage } from '../lib/homepage';
import { formatDate } from '../lib/dates';

const blogs = getBlogs();
const blogMap = getBlogMap(blogs);
const enrichedPosts = getEnrichedPosts({ blogs, blogMap });
const { leadPost, secondaryLead, alsoNew, featuredExcerpt, categoryPosts, archivePicks } =
  curateHomepage(enrichedPosts, blogMap);

function getCatColor(cat: string) {
  return `var(--${cat})`;
}

function truncateText(text: string, max: number) {
  const trimmed = text.trim();
  if (trimmed.length <= max) return trimmed;
  return `${trimmed.slice(0, max).trimEnd()}...`;
}
---

<Base title="The Small Web — Curated Indie Blogs" jsonLd={{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "The Small Web",
  "url": "https://smallweb.blog",
  "description": "A curated collection of the best indie blogs. Hand-picked writing from independent voices who care about their craft."
}}>
  <ThemeToggle />

  <div class="page">
    <Header currentPath="/" />

    <main class="home-main">
    <!-- Lead -->
    <section class="lead">
      <div class="lead-col">
        {leadPost && (
          <a href={leadPost.link} target="_blank" rel="noopener noreferrer" class="lead-main">
            <span class={`lead-stamp ${leadPost.category}`}>{leadPost.category} · {formatDate(leadPost.date)}</span>
            <h2 class="lead-title">{leadPost.title}</h2>
            <p class="lead-byline">By <strong>{leadPost.blogName}</strong> · {new URL(leadPost.blogUrl).hostname}</p>
            {leadPost.excerpt && <p class="lead-excerpt">{truncateText(leadPost.excerpt, 220)}</p>}
          </a>
        )}
        {secondaryLead && (
          <a href={secondaryLead.link} target="_blank" rel="noopener noreferrer" class="lead-secondary">
            <span class={`lead-stamp ${secondaryLead.category}`}>{secondaryLead.category} · {formatDate(secondaryLead.date)}</span>
            <h3 class="lead-secondary-title">{secondaryLead.title}</h3>
            <p class="lead-byline">By <strong>{secondaryLead.blogName}</strong> · {new URL(secondaryLead.blogUrl).hostname}</p>
            {secondaryLead.excerpt && <p class="lead-excerpt">{truncateText(secondaryLead.excerpt, 200)}</p>}
          </a>
        )}
      </div>
      <div class="lead-side">
        <div class="lead-side-label">Also New</div>
        {alsoNew.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="pick">
            <div class="pick-cat" style={`color:${getCatColor(post.category)}`}>
              <span class="pick-cat-dot" style={`background:${getCatColor(post.category)}`}></span>
              {post.category}
            </div>
            <h4 class="pick-title">{post.title}</h4>
            <p class="pick-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
    </section>

    <!-- See all link -->
    <div class="see-all-link">
      <a href="/feed">See all articles →</a>
    </div>

    <!-- Cut -->
    <div class="cut">✂</div>

    {/* ── Row 1: Tech + Culture — standard ink-on-paper 2-col ── */}
    {(() => {
      const lp = categoryPosts.get('tech') || [];
      const rp = categoryPosts.get('culture') || [];
      return (
        <section class="category-pair">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--tech)"></span>
              <span class="category-col-name">Tech</span>
              <a href="/category/tech" class="category-col-link">All tech →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(lp[0].excerpt, 160)}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--culture)"></span>
              <span class="category-col-name">Culture</span>
              <a href="/category/culture" class="category-col-link">All culture →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(rp[0].excerpt, 160)}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    {/* ── Featured Excerpt ── */}
    {featuredExcerpt && (
      <>
        <div class="cut">✕</div>
        <a href={featuredExcerpt.link} target="_blank" rel="noopener noreferrer" class="pasted-quote">
          <div class="pasted-quote-bg"></div>
          <div class="pasted-quote-inner">
            <div class="pasted-quote-label">From the blogs</div>
            <p class="pasted-quote-text">{featuredExcerpt.excerpt!.slice(0, 280)}{featuredExcerpt.excerpt!.length > 280 ? '...' : ''}</p>
            <div class="pasted-quote-src">{featuredExcerpt.blogName} · {featuredExcerpt.title}</div>
          </div>
        </a>
      </>
    )}

    <div class="cut">✂</div>

    {/* ── Row 2: Life + Design — wash band ── */}
    {(() => {
      const lp = categoryPosts.get('life') || [];
      const rp = categoryPosts.get('design') || [];
      return (
        <section class="category-pair category-pair--wash" style="--pair-wash-l: var(--life-wash); --pair-wash-r: var(--design-wash)">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--life)"></span>
              <span class="category-col-name">Life</span>
              <a href="/category/life" class="category-col-link">All life →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(lp[0].excerpt, 160)}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--design)"></span>
              <span class="category-col-name">Design</span>
              <a href="/category/design" class="category-col-link">All design →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(rp[0].excerpt, 160)}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    <div class="cut">✕</div>

    {/* ── Row 3: Economics + Finance — plain ── */}
    {(() => {
      const lp = categoryPosts.get('economics') || [];
      const rp = categoryPosts.get('finance') || [];
      return (
        <section class="category-pair">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--economics)"></span>
              <span class="category-col-name">Economics</span>
              <a href="/category/economics" class="category-col-link">All economics →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(lp[0].excerpt, 160)}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--finance)"></span>
              <span class="category-col-name">Finance</span>
              <a href="/category/finance" class="category-col-link">All finance →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(rp[0].excerpt, 160)}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    <div class="cut">✂</div>

    {/* ── Row 4: History + Philosophy — wash band ── */}
    {(() => {
      const lp = categoryPosts.get('history') || [];
      const rp = categoryPosts.get('philosophy') || [];
      return (
        <section class="category-pair category-pair--wash" style="--pair-wash-l: var(--history-wash); --pair-wash-r: var(--philosophy-wash)">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--history)"></span>
              <span class="category-col-name">History</span>
              <a href="/category/history" class="category-col-link">All history →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(lp[0].excerpt, 160)}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--philosophy)"></span>
              <span class="category-col-name">Philosophy</span>
              <a href="/category/philosophy" class="category-col-link">All philosophy →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(rp[0].excerpt, 160)}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    {/* ── From the Archives ── */}
    {archivePicks.length > 0 && (
      <section class="archives-strip">
        <div class="archives-strip-label">From the Archives</div>
        <div class="archives-strip-grid">
          {archivePicks.map((post) => (
            <a href={post.link} target="_blank" rel="noopener noreferrer" class="archives-strip-card" style={`--card-accent: var(--${post.category})`}>
              <span class="archives-strip-cat">
                <span class="archives-strip-cat-dot" style={`background:var(--${post.category})`}></span>
                {post.category}
              </span>
              <h4 class="archives-strip-title">{post.title}</h4>
              {post.excerpt && (
                <p class="archives-strip-excerpt">{truncateText(post.excerpt, 140)}</p>
              )}
              <p class="archives-strip-meta">{post.blogName}</p>
            </a>
          ))}
        </div>
      </section>
    )}

    <div class="cut">✕</div>

    {/* ── Row 5: Psychology + Science — plain ── */}
    {(() => {
      const lp = categoryPosts.get('psychology') || [];
      const rp = categoryPosts.get('science') || [];
      return (
        <section class="category-pair">
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--psychology)"></span>
              <span class="category-col-name">Psychology</span>
              <a href="/category/psychology" class="category-col-link">All psychology →</a>
            </div>
            {lp[0] && (
              <a href={lp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{lp[0].title}</h4>
                <p class="category-col-featured-meta">{lp[0].blogName} · {formatDate(lp[0].date)}</p>
                {lp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(lp[0].excerpt, 160)}</p>}
              </a>
            )}
            {lp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
          <div class="category-col">
            <div class="category-col-head">
              <span class="category-col-dot" style="background:var(--science)"></span>
              <span class="category-col-name">Science</span>
              <a href="/category/science" class="category-col-link">All science →</a>
            </div>
            {rp[0] && (
              <a href={rp[0].link} target="_blank" rel="noopener noreferrer" class="category-col-featured">
                <h4 class="category-col-featured-title">{rp[0].title}</h4>
                <p class="category-col-featured-meta">{rp[0].blogName} · {formatDate(rp[0].date)}</p>
                {rp[0].excerpt && <p class="category-col-featured-excerpt">{truncateText(rp[0].excerpt, 160)}</p>}
              </a>
            )}
            {rp.slice(1).map((post) => (
              <a href={post.link} target="_blank" rel="noopener noreferrer" class="category-col-item">
                <h4 class="category-col-item-title">{post.title}</h4>
                <p class="category-col-item-meta">{post.blogName} · {formatDate(post.date)}</p>
              </a>
            ))}
          </div>
        </section>
      );
    })()}

    </main>
    <Footer />
  </div>
</Base>
