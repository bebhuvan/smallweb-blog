---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import blogsData from '../../data/blogs.json';
import postsData from '../../data/cache/posts.json';

const blogs = blogsData.blogs;
const posts = postsData.posts;

const blogMap = new Map(blogs.map((b) => [b.id, b]));

const enrichedPosts = posts.map((post) => {
  const blog = blogMap.get(post.blogId);
  const category = blog?.categories?.[0];
  return {
    ...post,
    blogName: blog?.name || '',
    blogUrl: blog?.url || '',
    category: category || 'tech',
  };
});

// Track used IDs
const usedIds = new Set<string>();

// Lead post: most recent
const leadPost = enrichedPosts[0];
if (leadPost) usedIds.add(leadPost.id);

// Also New: next 4 most recent posts after the lead
const alsoNew = enrichedPosts.filter(p => !usedIds.has(p.id)).slice(0, 4);
alsoNew.forEach(p => usedIds.add(p.id));

// Tech section: 1 featured + 2 list
const techPosts = enrichedPosts.filter(p => p.category === 'tech' && !usedIds.has(p.id)).slice(0, 3);
techPosts.forEach(p => usedIds.add(p.id));

// Life section (tight): 3 items
const lifePosts = enrichedPosts.filter(p => p.category === 'life' && !usedIds.has(p.id)).slice(0, 3);
lifePosts.forEach(p => usedIds.add(p.id));

// Culture section (color band): 1 featured + 1 list
const culturePosts = enrichedPosts.filter(p => p.category === 'culture' && !usedIds.has(p.id)).slice(0, 2);
culturePosts.forEach(p => usedIds.add(p.id));

// Design section (tight in color band): 2 items
const designPosts = enrichedPosts.filter(p => p.category === 'design' && !usedIds.has(p.id)).slice(0, 2);
designPosts.forEach(p => usedIds.add(p.id));

// Bottom grid: economics, finance, history (2 each)
const economicsPosts = enrichedPosts.filter(p => p.category === 'economics' && !usedIds.has(p.id)).slice(0, 2);
economicsPosts.forEach(p => usedIds.add(p.id));

const financePosts = enrichedPosts.filter(p => p.category === 'finance' && !usedIds.has(p.id)).slice(0, 2);
financePosts.forEach(p => usedIds.add(p.id));

const historyPosts = enrichedPosts.filter(p => p.category === 'history' && !usedIds.has(p.id)).slice(0, 2);
historyPosts.forEach(p => usedIds.add(p.id));

// Featured excerpt: pick the post with the longest excerpt from prose-heavy categories
const proseCategories = ['philosophy', 'culture', 'life', 'psychology', 'history'];
const excerptCandidates = enrichedPosts
  .filter(p => proseCategories.includes(p.category) && p.excerpt && p.excerpt.length > 80 && !usedIds.has(p.id))
  .sort((a, b) => (b.excerpt?.length || 0) - (a.excerpt?.length || 0));
const featuredExcerpt = excerptCandidates[0] || null;
if (featuredExcerpt) usedIds.add(featuredExcerpt.id);

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  return 'Last month';
}

function getCatColor(cat: string) {
  return `var(--${cat})`;
}
---

<Base title="The Small Web — Curated Indie Blogs">
  <ThemeToggle />

  <div class="page">
    <Header currentPath="/" />

    <!-- Lead -->
    <section class="lead">
      {leadPost && (
        <a href={leadPost.link} target="_blank" rel="noopener noreferrer" class="lead-main">
          <span class={`lead-stamp ${leadPost.category}`}>{leadPost.category} · {formatDate(leadPost.date)}</span>
          <h2 class="lead-title">{leadPost.title}</h2>
          <p class="lead-byline">By <strong>{leadPost.blogName}</strong> · {new URL(leadPost.blogUrl).hostname}</p>
          {leadPost.excerpt && <p class="lead-excerpt">{leadPost.excerpt}</p>}
        </a>
      )}
      <div class="lead-side">
        <div class="lead-side-label">Also New</div>
        {alsoNew.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="pick">
            <div class="pick-cat" style={`color:${getCatColor(post.category)}`}>
              <span class="pick-cat-dot" style={`background:${getCatColor(post.category)}`}></span>
              {post.category}
            </div>
            <h4 class="pick-title">{post.title}</h4>
            <p class="pick-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
    </section>

    <!-- Cut -->
    <div class="cut">✂</div>

    <!-- Tech + Life Asymmetric -->
    <section class="asym">
      <div class="asym-main">
        <div class="asym-head">
          <span class="asym-head-dot" style="background:var(--tech)"></span>
          <span class="asym-head-text">Tech</span>
          <a href="/category/tech" class="asym-head-link">View all →</a>
        </div>
        {techPosts[0] && (
          <a href={techPosts[0].link} target="_blank" rel="noopener noreferrer" class="asym-featured">
            <h4 class="asym-featured-title">{techPosts[0].title}</h4>
            <p class="asym-featured-meta">{techPosts[0].blogName} · {formatDate(techPosts[0].date)}</p>
            {techPosts[0].excerpt && <p class="asym-featured-excerpt">{techPosts[0].excerpt}</p>}
          </a>
        )}
        {techPosts.slice(1).map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="asym-item">
            <h4 class="asym-item-title">{post.title}</h4>
            <p class="asym-item-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
      <div class="tight-col">
        <div class="tight-head">
          <span class="asym-head-dot" style="background:var(--life)"></span>
          Life
        </div>
        {lifePosts.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="tight-item">
            <h4 class="tight-item-title">{post.title}</h4>
            <p class="tight-item-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
    </section>

    <!-- Featured Excerpt -->
    {featuredExcerpt && (
      <a href={featuredExcerpt.link} target="_blank" rel="noopener noreferrer" class="pasted-quote">
        <div class="pasted-quote-bg"></div>
        <div class="pasted-quote-inner">
          <div class="pasted-quote-label">From the blogs</div>
          <p class="pasted-quote-text">{featuredExcerpt.excerpt!.slice(0, 280)}{featuredExcerpt.excerpt!.length > 280 ? '...' : ''}</p>
          <div class="pasted-quote-src">{featuredExcerpt.blogName} · {featuredExcerpt.title}</div>
        </div>
      </a>
    )}

    <!-- Cut -->
    <div class="cut">✕</div>

    <!-- Culture Color Band -->
    <div class="color-band">
      <section class="asym" style="padding-top:0; padding-bottom:0;">
        <div class="asym-main">
          <div class="asym-head">
            <span class="asym-head-dot" style="background:var(--culture)"></span>
            <span class="asym-head-text">Culture</span>
            <a href="/category/culture" class="asym-head-link">View all →</a>
          </div>
          {culturePosts[0] && (
            <a href={culturePosts[0].link} target="_blank" rel="noopener noreferrer" class="asym-featured">
              <h4 class="asym-featured-title">{culturePosts[0].title}</h4>
              <p class="asym-featured-meta">{culturePosts[0].blogName} · {formatDate(culturePosts[0].date)}</p>
              {culturePosts[0].excerpt && <p class="asym-featured-excerpt">{culturePosts[0].excerpt}</p>}
            </a>
          )}
          {culturePosts.slice(1).map((post) => (
            <a href={post.link} target="_blank" rel="noopener noreferrer" class="asym-item">
              <h4 class="asym-item-title">{post.title}</h4>
              <p class="asym-item-meta">{post.blogName} · {formatDate(post.date)}</p>
            </a>
          ))}
        </div>
        <div class="tight-col">
          <div class="tight-head">
            <span class="asym-head-dot" style="background:var(--design)"></span>
            Design
          </div>
          {designPosts.map((post) => (
            <a href={post.link} target="_blank" rel="noopener noreferrer" class="tight-item">
              <h4 class="tight-item-title">{post.title}</h4>
              <p class="tight-item-meta">{post.blogName} · {formatDate(post.date)}</p>
            </a>
          ))}
        </div>
      </section>
    </div>

    <!-- Cut -->
    <div class="cut">✂</div>

    <!-- Bottom 3-Column Grid -->
    <section class="bottom-grid">
      <div>
        <div class="bottom-col-head">
          <span class="asym-head-dot" style="background:var(--economics)"></span>
          Economics
        </div>
        {economicsPosts.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="bottom-item">
            <h4 class="bottom-item-title">{post.title}</h4>
            <p class="bottom-item-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
      <div>
        <div class="bottom-col-head">
          <span class="asym-head-dot" style="background:var(--finance)"></span>
          Finance
        </div>
        {financePosts.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="bottom-item">
            <h4 class="bottom-item-title">{post.title}</h4>
            <p class="bottom-item-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
      <div>
        <div class="bottom-col-head">
          <span class="asym-head-dot" style="background:var(--history)"></span>
          History
        </div>
        {historyPosts.map((post) => (
          <a href={post.link} target="_blank" rel="noopener noreferrer" class="bottom-item">
            <h4 class="bottom-item-title">{post.title}</h4>
            <p class="bottom-item-meta">{post.blogName} · {formatDate(post.date)}</p>
          </a>
        ))}
      </div>
    </section>

    <Footer />
  </div>
</Base>
