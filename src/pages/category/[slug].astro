---
import Base from '../../layouts/Base.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';
import blogsData from '../../../data/blogs.json';
import postsData from '../../../data/cache/posts.json';

export function getStaticPaths() {
  const categories = [
    { slug: 'tech', name: 'Tech', description: 'Code, tools, and digital innovation' },
    { slug: 'design', name: 'Design', description: 'Creativity, aesthetics, and user experience' },
    { slug: 'life', name: 'Life', description: 'Personal growth, career, and daily reflections' },
    { slug: 'culture', name: 'Culture', description: 'Society, trends, and the human experience' },
    { slug: 'economics', name: 'Economics', description: 'Policy, markets, and the science of choices' },
    { slug: 'finance', name: 'Finance', description: 'Investing, markets, and financial thinking' },
    { slug: 'history', name: 'History', description: 'Lessons and narratives from the past' },
    { slug: 'psychology', name: 'Psychology', description: 'Understanding the mind and behavior' },
    { slug: 'philosophy', name: 'Philosophy', description: 'Wisdom, ethics, and first principles' },
    { slug: 'science', name: 'Science', description: 'Physics, cosmology, and the nature of reality' },
  ];
  return categories.map((cat) => ({
    params: { slug: cat.slug },
    props: { category: cat },
  }));
}

const { slug } = Astro.params;
const { category } = Astro.props;

const blogs = blogsData.blogs;
const blogMap = new Map(blogs.map((b) => [b.id, b]));

const categoryBlogIds = new Set(
  blogs.filter((b) => b.categories.includes(slug as string)).map((b) => b.id)
);

const posts = postsData.posts
  .filter((p) => categoryBlogIds.has(p.blogId))
  .map((post) => {
    const blog = blogMap.get(post.blogId);
    return {
      ...post,
      blogName: blog?.name || '',
      category: category.slug,
    };
  });

const featuredPost = posts[0];
const remainingPosts = posts.slice(1);

// Find a post with a long excerpt for the quote block
const quotePost = posts.find((p) => p.excerpt && p.excerpt.length > 120);

// Group remaining posts by month
type PostsByMonth = { [key: string]: typeof posts };
const postsByMonth: PostsByMonth = {};

remainingPosts.forEach((post) => {
  const date = new Date(post.date);
  const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
  if (!postsByMonth[monthKey]) {
    postsByMonth[monthKey] = [];
  }
  postsByMonth[monthKey].push(post);
});

const sortedMonths = Object.keys(postsByMonth).sort((a, b) => {
  return new Date(b).getTime() - new Date(a).getTime();
});

function formatShortDate(dateStr: string) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<Base title={`${category.name} — The Small Web`} description={category.description} jsonLd={{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://smallweb.blog" },
    { "@type": "ListItem", "position": 2, "name": "Categories", "item": "https://smallweb.blog/blogs" },
    { "@type": "ListItem", "position": 3, "name": category.name }
  ]
}}>
  <ThemeToggle />

  <div class="page">
    <Header currentPath={`/category/${slug}`} currentCategory={slug as string} />

    <main class="category-main">
      <div class="category-hero" style={`background: var(--${slug}-wash)`}>
        <div class="category-hero-count">{posts.length} {posts.length === 1 ? 'article' : 'articles'}</div>
        <h1 class="category-hero-title">{category.name}</h1>
        <p class="category-hero-desc">{category.description}</p>
      </div>

      {posts.length > 0 ? (
        <div>
          {featuredPost && (
            <a href={featuredPost.link} target="_blank" rel="noopener noreferrer" class="asym-featured" style="margin-top: 1.5rem;">
              <h2 class="asym-featured-title">{featuredPost.title}</h2>
              <p class="asym-featured-meta">{featuredPost.blogName} · {formatShortDate(featuredPost.date)}</p>
              {featuredPost.excerpt && (
                <p class="asym-featured-excerpt">{featuredPost.excerpt}</p>
              )}
            </a>
          )}

          {quotePost && quotePost !== featuredPost && (
            <a href={quotePost.link} target="_blank" rel="noopener noreferrer" class="pasted-quote">
              <div class="pasted-quote-inner">
                <div class="pasted-quote-label">From this category</div>
                <p class="pasted-quote-text">{quotePost.excerpt}</p>
                <p class="pasted-quote-src">— {quotePost.blogName}</p>
              </div>
            </a>
          )}

          <div class="cut">✂</div>

          {sortedMonths.map((month) => (
            <section class="archive-month">
              <h2 class="month-header month-header-accented" style={`border-left-color: var(--${slug})`}>
                {month}
              </h2>
              <div class="archive-list">
                {postsByMonth[month].map((post) => (
                  <a
                    href={post.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="archive-item"
                  >
                    <span class="archive-date">{formatShortDate(post.date)}</span>
                    <div class="archive-content">
                      <h4 class="archive-title">{post.title}</h4>
                      <p class="archive-meta">{post.blogName}</p>
                    </div>
                  </a>
                ))}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <p class="empty-msg">No articles in this category yet.</p>
      )}
    </main>

    <Footer />
  </div>
</Base>

<style>
  .category-main {
    padding: 0 0 2rem;
  }

  .empty-msg {
    text-align: center;
    padding: 3rem;
    color: var(--ink-muted);
    font-size: 1rem;
  }

  @media (max-width: 600px) {
    .category-main { padding: 0 0 1.25rem; }
  }
</style>
