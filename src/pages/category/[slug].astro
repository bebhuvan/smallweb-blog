---
import Base from '../../layouts/Base.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';
import blogsData from '../../../data/blogs.json';
import postsData from '../../../data/cache/posts.json';

export function getStaticPaths() {
  const categories = [
    { slug: 'tech', name: 'Tech', description: 'Code, tools, and digital innovation' },
    { slug: 'design', name: 'Design', description: 'Creativity, aesthetics, and user experience' },
    { slug: 'life', name: 'Life', description: 'Personal growth, career, and daily reflections' },
    { slug: 'culture', name: 'Culture', description: 'Society, trends, and the human experience' },
    { slug: 'economics', name: 'Economics', description: 'Policy, markets, and the science of choices' },
    { slug: 'finance', name: 'Finance', description: 'Investing, markets, and financial thinking' },
    { slug: 'history', name: 'History', description: 'Lessons and narratives from the past' },
    { slug: 'psychology', name: 'Psychology', description: 'Understanding the mind and behavior' },
    { slug: 'philosophy', name: 'Philosophy', description: 'Wisdom, ethics, and first principles' },
    { slug: 'science', name: 'Science', description: 'Physics, cosmology, and the nature of reality' },
  ];
  return categories.map((cat) => ({
    params: { slug: cat.slug },
    props: { category: cat },
  }));
}

const { slug } = Astro.params;
const { category } = Astro.props;

const blogs = blogsData.blogs;
const blogMap = new Map(blogs.map((b) => [b.id, b]));

const categoryBlogIds = new Set(
  blogs.filter((b) => b.categories.includes(slug as string)).map((b) => b.id)
);

const posts = postsData.posts
  .filter((p) => categoryBlogIds.has(p.blogId))
  .map((post) => {
    const blog = blogMap.get(post.blogId);
    return {
      ...post,
      blogName: blog?.name || '',
      category: category.slug,
    };
  });

// Group posts by month
type PostsByMonth = { [key: string]: typeof posts };
const postsByMonth: PostsByMonth = {};

posts.forEach((post) => {
  const date = new Date(post.date);
  const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
  if (!postsByMonth[monthKey]) {
    postsByMonth[monthKey] = [];
  }
  postsByMonth[monthKey].push(post);
});

const sortedMonths = Object.keys(postsByMonth).sort((a, b) => {
  return new Date(b).getTime() - new Date(a).getTime();
});

function formatShortDate(dateStr: string) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<Base title={`${category.name} — The Small Web`} description={category.description}>
  <ThemeToggle />

  <div class="page">
    <Header currentPath={`/category/${slug}`} currentCategory={slug as string} />

    <main class="category-main">
      <div class="category-header">
        <div class="category-dot" style={`background: var(--${slug})`}></div>
        <h2 class="category-name">{category.name}</h2>
        <p class="category-desc">{category.description}</p>
        <p class="category-count">{posts.length} {posts.length === 1 ? 'article' : 'articles'}</p>
      </div>

      {posts.length > 0 ? (
        <div>
          {sortedMonths.map((month) => (
            <section class="archive-month">
              <h2 class="month-header">{month}</h2>
              <div class="archive-list">
                {postsByMonth[month].map((post) => (
                  <a
                    href={post.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="asym-item"
                  >
                    <h4 class="asym-item-title">{post.title}</h4>
                    <p class="asym-item-meta">{post.blogName} · {formatShortDate(post.date)}</p>
                  </a>
                ))}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <p class="empty-msg">No articles in this category yet.</p>
      )}
    </main>

    <Footer />
  </div>
</Base>

<style>
  .category-main {
    padding: 2rem 0;
  }

  .category-header {
    margin-bottom: 2.5rem;
  }

  .category-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-bottom: 0.75rem;
  }

  .category-name {
    font-family: var(--serif);
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 0.35rem;
  }

  .category-desc {
    font-size: 0.95rem;
    color: var(--ink-muted);
  }

  .category-count {
    font-size: 0.8rem;
    color: var(--ink-faint);
    margin-top: 0.25rem;
  }

  .empty-msg {
    text-align: center;
    padding: 3rem;
    color: var(--ink-muted);
    font-size: 1rem;
  }

  @media (max-width: 600px) {
    .category-name { font-size: 1.6rem; }
    .category-desc { font-size: 0.85rem; }
    .category-header { margin-bottom: 1.75rem; }
    .category-main { padding: 1.25rem 0; }
  }
</style>
