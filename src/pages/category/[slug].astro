---
import Base from '../../layouts/Base.astro';
import blogsData from '../../../data/blogs.json';
import postsData from '../../../data/cache/posts.json';

export function getStaticPaths() {
  const categories = [
    { slug: 'tech', name: 'Tech', description: 'Code, tools, and digital innovation' },
    { slug: 'design', name: 'Design', description: 'Creativity, aesthetics, and user experience' },
    { slug: 'life', name: 'Life', description: 'Personal growth, career, and daily reflections' },
    { slug: 'culture', name: 'Culture', description: 'Society, trends, and the human experience' },
    { slug: 'economics', name: 'Economics', description: 'Policy, markets, and the science of choices' },
    { slug: 'finance', name: 'Finance', description: 'Investing, markets, and financial thinking' },
    { slug: 'history', name: 'History', description: 'Lessons and narratives from the past' },
    { slug: 'psychology', name: 'Psychology', description: 'Understanding the mind and behavior' },
    { slug: 'philosophy', name: 'Philosophy', description: 'Wisdom, ethics, and first principles' },
  ];
  return categories.map((cat) => ({
    params: { slug: cat.slug },
    props: { category: cat },
  }));
}

const { slug } = Astro.params;
const { category } = Astro.props;

const blogs = blogsData.blogs;
const blogMap = new Map(blogs.map((b) => [b.id, b]));

const categoryBlogIds = new Set(
  blogs.filter((b) => b.categories.includes(slug as string)).map((b) => b.id)
);

const posts = postsData.posts
  .filter((p) => categoryBlogIds.has(p.blogId))
  .map((post) => {
    const blog = blogMap.get(post.blogId);
    return {
      ...post,
      blogName: blog?.name || '',
      category: category.slug,
    };
  });

// Group posts by month
type PostsByMonth = { [key: string]: typeof posts };
const postsByMonth: PostsByMonth = {};

posts.forEach((post) => {
  const date = new Date(post.date);
  const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
  if (!postsByMonth[monthKey]) {
    postsByMonth[monthKey] = [];
  }
  postsByMonth[monthKey].push(post);
});

const sortedMonths = Object.keys(postsByMonth).sort((a, b) => {
  return new Date(b).getTime() - new Date(a).getTime();
});

function formatShortDate(dateStr: string) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<Base title={`${category.name} — The Small Web`} description={category.description}>
  <header class="site-header">
    <div class="header-inner">
      <a href="/" class="logo">The Small Web</a>
      <nav class="header-nav">
        <a href="/">Home</a>
        <a href="/archive">Archive</a>
        <a href="/blogs">Blogs</a>
        <a href="/about">About</a>
        <a href="https://buymeacoffee.com/bebhuvan" target="_blank" rel="noopener" class="nav-support">Support</a>
        <button class="theme-toggle" id="theme-toggle">Dark mode</button>
      </nav>
    </div>
  </header>

  <nav class="category-nav">
    <ul>
      <li><a href="/archive">All</a></li>
      <li><a href="/category/tech" class={slug === 'tech' ? 'active' : ''}><span class="cat-dot tech"></span>Tech</a></li>
      <li><a href="/category/design" class={slug === 'design' ? 'active' : ''}><span class="cat-dot design"></span>Design</a></li>
      <li><a href="/category/life" class={slug === 'life' ? 'active' : ''}><span class="cat-dot life"></span>Life</a></li>
      <li><a href="/category/culture" class={slug === 'culture' ? 'active' : ''}><span class="cat-dot culture"></span>Culture</a></li>
      <li><a href="/category/economics" class={slug === 'economics' ? 'active' : ''}><span class="cat-dot economics"></span>Economics</a></li>
      <li><a href="/category/finance" class={slug === 'finance' ? 'active' : ''}><span class="cat-dot finance"></span>Finance</a></li>
      <li><a href="/category/history" class={slug === 'history' ? 'active' : ''}><span class="cat-dot history"></span>History</a></li>
      <li><a href="/category/psychology" class={slug === 'psychology' ? 'active' : ''}><span class="cat-dot psychology"></span>Psychology</a></li>
      <li><a href="/category/philosophy" class={slug === 'philosophy' ? 'active' : ''}><span class="cat-dot philosophy"></span>Philosophy</a></li>
    </ul>
  </nav>

  <main style="max-width: 900px; margin: 0 auto; padding: 3rem 2rem;">
    <div class="page-header">
      <h1 class="page-title" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
        <span class={`col-dot ${slug}`} style="width: 16px; height: 16px;"></span>
        {category.name}
      </h1>
      <p class="page-subtitle">{category.description}</p>
      <p style="font-size: 0.9rem; color: var(--text-faint); margin-top: 0.5rem;">
        {posts.length} {posts.length === 1 ? 'article' : 'articles'}
      </p>
    </div>

    {posts.length > 0 ? (
      <div id="archive-content">
        {sortedMonths.map((month) => (
          <section class="archive-month">
            <h2 class="month-header">{month}</h2>
            <div class="archive-list">
              {postsByMonth[month].map((post) => (
                <a
                  href={post.link}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="archive-item"
                >
                  <span class="archive-date">{formatShortDate(post.date)}</span>
                  <div class="archive-content">
                    <h3 class="archive-title">{post.title}</h3>
                    <p class="archive-meta">{post.blogName}</p>
                  </div>
                  <span class={`archive-category ${slug}`}>{category.name}</span>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
        <p style="font-size: 1.1rem;">No articles in this category yet.</p>
      </div>
    )}
  </main>

  <footer class="site-footer">
    <p class="footer-text">A curated feed of indie blogs · <a href="/rss.xml" style="color: var(--accent);">RSS</a> · <a href="/status" style="color: var(--accent);">Status</a></p>
  </footer>

  <script>
    const toggle = document.getElementById('theme-toggle');

    function updateButtonText() {
      if (toggle) {
        toggle.textContent = document.documentElement.classList.contains('dark') ? 'Light mode' : 'Dark mode';
      }
    }

    toggle?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.theme = isDark ? 'dark' : 'light';
      updateButtonText();
    });

    updateButtonText();
  </script>
</Base>
