---
import Base from '../layouts/Base.astro';
import blogsData from '../../data/blogs.json';
import postsData from '../../data/cache/posts.json';

const blogs = blogsData.blogs;
const posts = postsData.posts;

const blogMap = new Map(blogs.map((b) => [b.id, b]));

// Enrich posts with blog data
const enrichedPosts = posts.map((post) => {
  const blog = blogMap.get(post.blogId);
  const category = blog?.categories?.[0];
  return {
    ...post,
    blogName: blog?.name || '',
    blogUrl: blog?.url || '',
    category: category || 'tech',
  };
});

// Shuffle for discovery (different each visit)
const shuffled = [...enrichedPosts].sort(() => Math.random() - 0.5);

// Take first 20 for the deck
const deckPosts = shuffled.slice(0, 20);

// Category colors for inline styles
const categoryColors: Record<string, string> = {
  tech: 'var(--tech)',
  life: 'var(--life)',
  culture: 'var(--culture)',
  design: 'var(--design)',
  finance: 'var(--finance)',
  economics: 'var(--economics)',
  history: 'var(--history)',
  psychology: 'var(--psychology)',
  philosophy: 'var(--philosophy)',
};
---

<Base title="Discover — The Small Web">
  <header class="site-header">
    <div class="header-inner">
      <a href="/" class="logo">The Small Web</a>
      <nav class="header-nav">
        <a href="/">Home</a>
        <a href="/discover" class="active">Discover</a>
        <a href="/archive">Archive</a>
        <a href="/blogs">Blogs</a>
        <a href="/about">About</a>
        <button class="theme-toggle" id="theme-toggle">Dark mode</button>
      </nav>
    </div>
  </header>

  <main class="discover-main">
    <section class="discover-hero">
      <h1>Discover</h1>
      <p>Swipe through hand-picked reads from indie blogs.</p>
    </section>

    <div class="stack-container">
      <div class="stack" id="cardStack">
        {deckPosts.slice(0, 5).reverse().map((post, index) => (
          <article
            class="discover-card"
            style={`--card-color: ${categoryColors[post.category] || 'var(--accent)'}`}
            data-link={post.link}
          >
            <span class={`discover-badge ${post.category}`}>{post.category}</span>
            <h2 class="discover-title">{post.title}</h2>
            <p class="discover-excerpt">{post.excerpt || 'Click to read the full article on the original blog.'}</p>
            <div class="discover-meta">
              <div class="discover-author">
                <span class="author-name">{post.blogName}</span>
                <span class="blog-url">{new URL(post.blogUrl).hostname}</span>
              </div>
            </div>
          </article>
        ))}
      </div>

      <div class="card-count">
        <span id="currentCard">1</span> / <span id="totalCards">{Math.min(deckPosts.length, 20)}</span>
      </div>
    </div>

    <div class="discover-hint">
      <kbd>←</kbd> <kbd>→</kbd> Browse <span class="hint-divider">·</span>
      <kbd>Enter</kbd> Read
    </div>

    <div class="discover-actions">
      <button class="action-btn next" id="nextBtn" title="Next">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
      <button class="action-btn read" id="readBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
          <polyline points="15,3 21,3 21,9"/>
          <line x1="10" y1="14" x2="21" y2="3"/>
        </svg>
        Read Article
      </button>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <span class="footer-stat"><span class="footer-stat-value">{blogs.length}</span> blogs</span>
      <span class="footer-divider"></span>
      <span class="footer-stat">No algorithms</span>
      <span class="footer-divider"></span>
      <span class="footer-stat"><a href="https://github.com/bebhuvan/smallweb-blog" target="_blank" rel="noopener" style="color: var(--text-muted);">GitHub</a></span>
    </div>
  </footer>

  <script define:vars={{ allPosts: deckPosts }}>
    // State
    let currentIndex = 0;
    let isAnimating = false;
    const posts = allPosts;

    // Card positions (transform values for each position in stack)
    const stackPositions = [
      { y: 0, rotate: -0.5, scale: 1, opacity: 1 },
      { y: 12, rotate: 0.5, scale: 0.98, opacity: 0.7 },
      { y: 24, rotate: -0.3, scale: 0.96, opacity: 0.5 },
      { y: 36, rotate: 0.3, scale: 0.94, opacity: 0.3 },
      { y: 48, rotate: -0.5, scale: 0.92, opacity: 0.15 },
    ];

    // Elements
    const stack = document.getElementById('cardStack');
    const currentCardEl = document.getElementById('currentCard');
    const nextBtn = document.getElementById('nextBtn');
    const readBtn = document.getElementById('readBtn');

    // Apply position to card
    function setCardPosition(card, pos, immediate = false) {
      if (immediate) {
        card.style.transition = 'none';
      } else {
        card.style.transition = 'transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s cubic-bezier(0.22, 1, 0.36, 1)';
      }
      card.style.transform = `translateY(${pos.y}px) rotate(${pos.rotate}deg) scale(${pos.scale})`;
      card.style.opacity = pos.opacity;
      card.style.zIndex = 10 - stackPositions.indexOf(pos);

      if (immediate) {
        // Force reflow then restore transition
        card.offsetHeight;
        card.style.transition = 'transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s cubic-bezier(0.22, 1, 0.36, 1)';
      }
    }

    // Update all card positions
    function updateStackPositions() {
      const cards = Array.from(stack.querySelectorAll('.discover-card')).reverse();
      cards.forEach((card, i) => {
        if (i < stackPositions.length) {
          setCardPosition(card, stackPositions[i]);
        }
      });
    }

    // Get top card
    function getTopCard() {
      const cards = stack.querySelectorAll('.discover-card');
      return cards[cards.length - 1];
    }

    // Update counter
    function updateCounter() {
      currentCardEl.textContent = Math.min(currentIndex + 1, posts.length);
    }

    // Create a new card element
    function createCardElement(post, positionIndex) {
      const card = document.createElement('article');
      card.className = 'discover-card';

      const categoryColors = {
        tech: 'var(--tech)',
        life: 'var(--life)',
        culture: 'var(--culture)',
        design: 'var(--design)',
        finance: 'var(--finance)',
        economics: 'var(--economics)',
        history: 'var(--history)',
        psychology: 'var(--psychology)',
        philosophy: 'var(--philosophy)',
      };

      card.style.setProperty('--card-color', categoryColors[post.category] || 'var(--accent)');
      card.dataset.link = post.link;

      const badge = document.createElement('span');
      badge.className = `discover-badge ${post.category}`;
      badge.textContent = post.category;

      const title = document.createElement('h2');
      title.className = 'discover-title';
      title.textContent = post.title;

      const excerpt = document.createElement('p');
      excerpt.className = 'discover-excerpt';
      excerpt.textContent = post.excerpt || 'Click to read the full article on the original blog.';

      const meta = document.createElement('div');
      meta.className = 'discover-meta';

      const author = document.createElement('div');
      author.className = 'discover-author';

      const authorName = document.createElement('span');
      authorName.className = 'author-name';
      authorName.textContent = post.blogName;

      const blogUrl = document.createElement('span');
      blogUrl.className = 'blog-url';
      try {
        blogUrl.textContent = new URL(post.blogUrl).hostname;
      } catch (e) {
        blogUrl.textContent = post.blogUrl;
      }

      author.appendChild(authorName);
      author.appendChild(blogUrl);
      meta.appendChild(author);

      card.appendChild(badge);
      card.appendChild(title);
      card.appendChild(excerpt);
      card.appendChild(meta);

      // Set initial position (off-screen at bottom)
      const pos = stackPositions[positionIndex] || stackPositions[stackPositions.length - 1];
      setCardPosition(card, { ...pos, y: pos.y + 30, opacity: 0 }, true);

      return card;
    }

    // Add new card to bottom of stack
    function addCardToStack() {
      const nextIndex = currentIndex + 4;
      if (nextIndex >= posts.length) return;

      const post = posts[nextIndex];
      const card = createCardElement(post, 4);
      stack.insertBefore(card, stack.firstChild);

      // Animate in after a frame
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          updateStackPositions();
        });
      });
    }

    // Show end state
    function showEndState() {
      const endDiv = document.createElement('div');
      endDiv.className = 'end-state';

      const h3 = document.createElement('h3');
      h3.textContent = "You've explored them all!";

      const p = document.createElement('p');
      p.textContent = 'Refresh for a new shuffle, or check back later';

      const link = document.createElement('a');
      link.href = '/';
      link.className = 'back-link';
      link.textContent = '← Back to Home';

      endDiv.appendChild(h3);
      endDiv.appendChild(p);
      endDiv.appendChild(link);

      stack.appendChild(endDiv);
    }

    // Handle next/skip
    function handleNext() {
      if (isAnimating) return;

      const topCard = getTopCard();
      if (!topCard) return;

      isAnimating = true;

      // Animate top card out
      topCard.style.transition = 'transform 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.35s ease-out';
      topCard.style.transform = 'translateX(-120%) translateY(-30px) rotate(-12deg)';
      topCard.style.opacity = '0';
      topCard.style.pointerEvents = 'none';

      // Animate remaining cards up
      const cards = Array.from(stack.querySelectorAll('.discover-card')).reverse();
      cards.forEach((card, i) => {
        if (card !== topCard && i > 0 && i <= stackPositions.length) {
          setCardPosition(card, stackPositions[i - 1]);
        }
      });

      // Clean up after animation
      setTimeout(() => {
        topCard.remove();
        currentIndex++;
        updateCounter();
        addCardToStack();

        const remainingCards = stack.querySelectorAll('.discover-card');
        if (remainingCards.length === 0) {
          showEndState();
        }

        isAnimating = false;
      }, 400);
    }

    // Handle read
    function handleRead() {
      const topCard = getTopCard();
      if (!topCard) return;
      const link = topCard.dataset.link;
      if (link) window.open(link, '_blank', 'noopener,noreferrer');
    }

    // Event listeners
    nextBtn.addEventListener('click', handleNext);
    readBtn.addEventListener('click', handleRead);

    // Click on card to read
    stack.addEventListener('click', (e) => {
      const card = e.target.closest('.discover-card');
      if (card && card === getTopCard()) {
        handleRead();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') handleNext();
      if (e.key === 'Enter') handleRead();
    });

    // Theme toggle
    const toggle = document.getElementById('theme-toggle');
    function updateButtonText() {
      if (toggle) {
        toggle.textContent = document.documentElement.classList.contains('dark') ? 'Light mode' : 'Dark mode';
      }
    }
    toggle?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      updateButtonText();
    });
    updateButtonText();

    // Initialize card positions
    updateStackPositions();
  </script>
</Base>

<style>
  /* Discover Page Styles */
  .discover-main {
    max-width: 100%;
    padding: 0;
  }

  .discover-hero {
    text-align: center;
    padding: var(--space-8) var(--space-6) var(--space-5);
  }

  .discover-hero h1 {
    font-family: var(--serif);
    font-size: var(--text-4xl);
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: var(--space-3);
  }

  .discover-hero p {
    font-size: var(--text-lg);
    color: var(--text-muted);
  }

  /* Stack Container */
  .stack-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-4) var(--space-6);
    min-height: 480px;
  }

  .stack {
    position: relative;
    width: 100%;
    max-width: 400px;
    height: 440px;
  }

  .card-count {
    margin-top: var(--space-5);
    font-size: var(--text-sm);
    color: var(--text-faint);
    font-variant-numeric: tabular-nums;
  }

  /* Cards */
  .discover-card {
    position: absolute;
    width: 100%;
    height: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: var(--space-6);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    transform-origin: center center;
    user-select: none;
    will-change: transform, opacity;
    /* Transition set via JS for precise control */
  }

  .dark .discover-card {
    background: var(--bg-soft);
  }

  .discover-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--card-color);
    border-radius: 16px 16px 0 0;
  }

  /* Card shadows */
  .discover-card {
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
  }

  .dark .discover-card {
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.25);
  }

  /* Card content */
  .discover-badge {
    display: inline-flex;
    align-self: flex-start;
    font-size: var(--text-xs);
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    padding: 0.35rem 0.85rem;
    border-radius: 100px;
    margin-bottom: var(--space-4);
  }

  .discover-badge.tech { background: var(--tech-soft); color: var(--tech); }
  .discover-badge.life { background: var(--life-soft); color: var(--life); }
  .discover-badge.culture { background: var(--culture-soft); color: var(--culture); }
  .discover-badge.design { background: var(--design-soft); color: var(--design); }
  .discover-badge.finance { background: var(--finance-soft); color: var(--finance); }
  .discover-badge.economics { background: var(--economics-soft); color: var(--economics); }
  .discover-badge.history { background: var(--history-soft); color: var(--history); }
  .discover-badge.psychology { background: var(--psychology-soft); color: var(--psychology); }
  .discover-badge.philosophy { background: var(--philosophy-soft); color: var(--philosophy); }

  .discover-title {
    font-family: var(--serif);
    font-size: 1.75rem;
    font-weight: 600;
    line-height: var(--leading-tight);
    letter-spacing: -0.02em;
    margin-bottom: var(--space-4);
  }

  .discover-excerpt {
    font-size: 1rem;
    line-height: var(--leading-normal);
    color: var(--text-muted);
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
  }

  .discover-meta {
    margin-top: auto;
    padding-top: var(--space-5);
    border-top: 1px solid var(--border);
  }

  .discover-author {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .author-name {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .blog-url {
    font-size: var(--text-sm);
    color: var(--text-faint);
  }

  /* Hint */
  .discover-hint {
    text-align: center;
    padding: var(--space-4);
    color: var(--text-faint);
    font-size: var(--text-sm);
  }

  .discover-hint kbd {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: var(--bg-soft);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-family: inherit;
    font-size: var(--text-xs);
    margin: 0 0.15rem;
  }

  .hint-divider {
    margin: 0 var(--space-3);
    color: var(--border);
  }

  /* Actions */
  .discover-actions {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-2) var(--space-6) var(--space-8);
  }

  .action-btn {
    height: 52px;
    border-radius: 100px;
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    background: var(--bg);
    color: var(--text-muted);
    font-family: var(--sans);
  }

  .action-btn:hover {
    border-color: var(--text-faint);
    color: var(--text);
  }

  .action-btn:active {
    transform: scale(0.97);
  }

  .action-btn.next {
    width: 52px;
    background: var(--bg-soft);
  }

  .action-btn.next:hover {
    background: var(--bg);
  }

  .action-btn.read {
    padding: 0 var(--space-6);
    font-weight: 600;
    font-size: var(--text-sm);
    gap: var(--space-2);
    background: var(--text);
    border-color: var(--text);
    color: var(--bg);
  }

  .action-btn.read:hover {
    opacity: 0.9;
    border-color: var(--text);
  }

  .action-btn svg {
    width: 20px;
    height: 20px;
  }

  /* End state */
  .end-state {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-muted);
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  .end-state h3 {
    font-family: var(--serif);
    font-size: var(--text-xl);
    font-weight: 500;
    margin-bottom: var(--space-2);
    color: var(--text);
  }

  .end-state p {
    margin-bottom: var(--space-5);
    font-size: var(--text-sm);
  }

  .back-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    font-size: var(--text-sm);
  }

  .back-link:hover {
    text-decoration: underline;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .discover-hero h1 {
      font-size: var(--text-3xl);
    }

    .stack {
      max-width: 340px;
      height: 400px;
    }

    .discover-title {
      font-size: 1.5rem;
    }

    .discover-card {
      padding: var(--space-5);
    }
  }

  @media (max-width: 480px) {
    .discover-hero {
      padding: var(--space-6) var(--space-4) var(--space-4);
    }

    .stack-container {
      padding: var(--space-4);
    }

    .stack {
      max-width: 100%;
      height: 380px;
    }

    .discover-hint {
      font-size: var(--text-xs);
    }

    .hint-divider {
      margin: 0 var(--space-2);
    }

    .discover-actions {
      padding: var(--space-2) var(--space-4) var(--space-6);
    }
  }
</style>
