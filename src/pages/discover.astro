---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import blogsData from '../../data/blogs.json';
import postsData from '../../data/cache/posts.json';

const blogs = blogsData.blogs;
const posts = postsData.posts;

const blogMap = new Map(blogs.map((b) => [b.id, b]));

const enrichedPosts = posts.map((post) => {
  const blog = blogMap.get(post.blogId);
  const category = blog?.categories?.[0];
  return {
    ...post,
    blogName: blog?.name || '',
    blogUrl: blog?.url || '',
    category: category || 'tech',
  };
});

// Shuffle for discovery
const shuffled = [...enrichedPosts].sort(() => Math.random() - 0.5);
const deckPosts = shuffled.slice(0, 20);

const categoryColors: Record<string, string> = {
  tech: 'var(--tech)', life: 'var(--life)', culture: 'var(--culture)',
  design: 'var(--design)', finance: 'var(--finance)', economics: 'var(--economics)',
  history: 'var(--history)', psychology: 'var(--psychology)', philosophy: 'var(--philosophy)',
  science: 'var(--science)',
};

const categories = ['tech', 'design', 'life', 'culture', 'economics', 'finance', 'history', 'psychology', 'philosophy', 'science'];
const categoryNames: Record<string, string> = {
  tech: 'Tech', design: 'Design', life: 'Life', culture: 'Culture',
  finance: 'Finance', economics: 'Economics', history: 'History',
  psychology: 'Psychology', philosophy: 'Philosophy', science: 'Science',
};
---

<Base title="Discover — The Small Web">
  <ThemeToggle />

  <div class="page">
    <Header currentPath="/discover" />

    <main class="discover-main">
      <div class="editorial-header" style="text-align: center;">
        <h1 class="editorial-title">Discover</h1>
        <p class="editorial-sub">Swipe through hand-picked reads from indie blogs</p>
        <hr class="editorial-rule" style="margin-left: auto; margin-right: auto; max-width: 200px;">
      </div>

      <div class="filter-ribbon">
        <button class="stamp active" data-filter="all">All</button>
        {categories.map(cat => (
          <button class="stamp" data-filter={cat}>
            <span class="stamp-dot" style={`background:var(--${cat})`}></span>
            {categoryNames[cat]}
          </button>
        ))}
      </div>

      <div class="stack-container">
        <div class="stack" id="cardStack">
          {deckPosts.slice(0, 5).reverse().map((post) => (
            <article
              class="discover-card"
              style={`--card-color: ${categoryColors[post.category] || 'var(--accent)'}`}
              data-link={post.link}
              data-category={post.category}
            >
              <span class={`discover-badge ${post.category}`}>{post.category}</span>
              <h2 class="discover-title">{post.title}</h2>
              <p class="discover-excerpt">{post.excerpt || 'Click to read the full article on the original blog.'}</p>
              <div class="discover-meta">
                <div class="discover-author">
                  <span class="author-name">{post.blogName}</span>
                  <span class="blog-hostname">{new URL(post.blogUrl).hostname}</span>
                </div>
              </div>
            </article>
          ))}
        </div>

        <div class="card-count">
          <span id="currentCard">1</span> / <span id="totalCards">{Math.min(deckPosts.length, 20)}</span>
        </div>
      </div>

      <div class="discover-hint">
        <kbd>←</kbd> <kbd>→</kbd> Browse <span class="hint-sep">·</span>
        <kbd>Enter</kbd> Read
      </div>

      <div class="discover-actions">
        <button class="action-btn next" id="nextBtn" title="Next">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        <button class="action-btn read" id="readBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15,3 21,3 21,9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
          Read Article
        </button>
      </div>
    </main>

    <Footer />
  </div>

  <script define:vars={{ allPosts: deckPosts }}>
    let currentIndex = 0;
    let isAnimating = false;
    let posts = allPosts;
    let filteredPosts = [...posts];

    const stackPositions = [
      { y: 0, rotate: -0.5, scale: 1, opacity: 1 },
      { y: 12, rotate: 0.5, scale: 0.98, opacity: 0.7 },
      { y: 24, rotate: -0.3, scale: 0.96, opacity: 0.5 },
      { y: 36, rotate: 0.3, scale: 0.94, opacity: 0.3 },
      { y: 48, rotate: -0.5, scale: 0.92, opacity: 0.15 },
    ];

    const stack = document.getElementById('cardStack');
    const currentCardEl = document.getElementById('currentCard');
    const totalCardsEl = document.getElementById('totalCards');
    const nextBtn = document.getElementById('nextBtn');
    const readBtn = document.getElementById('readBtn');

    // Filter ribbon
    const filterBtns = document.querySelectorAll('.filter-ribbon .stamp');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const cat = btn.dataset.filter;
        if (cat === 'all') {
          filteredPosts = [...posts];
        } else {
          filteredPosts = posts.filter(p => p.category === cat);
        }
        currentIndex = 0;
        rebuildStack();
      });
    });

    function rebuildStack() {
      // Remove all existing cards
      while (stack.firstChild) {
        stack.removeChild(stack.firstChild);
      }
      if (filteredPosts.length === 0) {
        showEndState();
        return;
      }
      const toShow = filteredPosts.slice(0, 5).reverse();
      toShow.forEach(post => {
        const card = createCardElement(post, 0);
        stack.appendChild(card);
      });
      totalCardsEl.textContent = String(filteredPosts.length);
      updateCounter();
      updateStackPositions();
    }

    function setCardPosition(card, pos, immediate = false) {
      if (immediate) {
        card.style.transition = 'none';
      } else {
        card.style.transition = 'transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s cubic-bezier(0.22, 1, 0.36, 1)';
      }
      card.style.transform = `translateY(${pos.y}px) rotate(${pos.rotate}deg) scale(${pos.scale})`;
      card.style.opacity = pos.opacity;
      card.style.zIndex = 10 - stackPositions.indexOf(pos);

      if (immediate) {
        card.offsetHeight;
        card.style.transition = 'transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s cubic-bezier(0.22, 1, 0.36, 1)';
      }
    }

    function updateStackPositions() {
      const cards = Array.from(stack.querySelectorAll('.discover-card')).reverse();
      cards.forEach((card, i) => {
        if (i < stackPositions.length) {
          setCardPosition(card, stackPositions[i]);
        }
      });
    }

    function getTopCard() {
      const cards = stack.querySelectorAll('.discover-card');
      return cards[cards.length - 1];
    }

    function updateCounter() {
      currentCardEl.textContent = String(Math.min(currentIndex + 1, filteredPosts.length));
    }

    function createCardElement(post, positionIndex) {
      const card = document.createElement('article');
      card.className = 'discover-card';

      const categoryColors = {
        tech: 'var(--tech)', life: 'var(--life)', culture: 'var(--culture)',
        design: 'var(--design)', finance: 'var(--finance)', economics: 'var(--economics)',
        history: 'var(--history)', psychology: 'var(--psychology)', philosophy: 'var(--philosophy)',
        science: 'var(--science)',
      };

      card.style.setProperty('--card-color', categoryColors[post.category] || 'var(--accent)');
      card.dataset.link = post.link;
      card.dataset.category = post.category;

      const badge = document.createElement('span');
      badge.className = `discover-badge ${post.category}`;
      badge.textContent = post.category;

      const title = document.createElement('h2');
      title.className = 'discover-title';
      title.textContent = post.title;

      const excerpt = document.createElement('p');
      excerpt.className = 'discover-excerpt';
      excerpt.textContent = post.excerpt || 'Click to read the full article on the original blog.';

      const meta = document.createElement('div');
      meta.className = 'discover-meta';

      const author = document.createElement('div');
      author.className = 'discover-author';

      const authorName = document.createElement('span');
      authorName.className = 'author-name';
      authorName.textContent = post.blogName;

      const blogUrl = document.createElement('span');
      blogUrl.className = 'blog-hostname';
      try {
        blogUrl.textContent = new URL(post.blogUrl).hostname;
      } catch (e) {
        blogUrl.textContent = post.blogUrl;
      }

      author.appendChild(authorName);
      author.appendChild(blogUrl);
      meta.appendChild(author);

      card.appendChild(badge);
      card.appendChild(title);
      card.appendChild(excerpt);
      card.appendChild(meta);

      const pos = stackPositions[positionIndex] || stackPositions[stackPositions.length - 1];
      setCardPosition(card, { ...pos, y: pos.y + 30, opacity: 0 }, true);

      return card;
    }

    function addCardToStack() {
      const nextIndex = currentIndex + 4;
      if (nextIndex >= filteredPosts.length) return;
      const post = filteredPosts[nextIndex];
      const card = createCardElement(post, 4);
      stack.insertBefore(card, stack.firstChild);
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          updateStackPositions();
        });
      });
    }

    function showEndState() {
      const endDiv = document.createElement('div');
      endDiv.className = 'end-state';
      const h3 = document.createElement('h3');
      h3.textContent = "You've explored them all!";
      const p = document.createElement('p');
      p.textContent = 'Refresh for a new shuffle, or check back later';
      const link = document.createElement('a');
      link.href = '/';
      link.className = 'back-link';
      link.textContent = '\u2190 Back to Home';
      endDiv.appendChild(h3);
      endDiv.appendChild(p);
      endDiv.appendChild(link);
      stack.appendChild(endDiv);
    }

    function handleNext() {
      if (isAnimating) return;
      const topCard = getTopCard();
      if (!topCard) return;
      isAnimating = true;
      topCard.style.transition = 'transform 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.35s ease-out';
      topCard.style.transform = 'translateX(-120%) translateY(-30px) rotate(-12deg)';
      topCard.style.opacity = '0';
      topCard.style.pointerEvents = 'none';
      const cards = Array.from(stack.querySelectorAll('.discover-card')).reverse();
      cards.forEach((card, i) => {
        if (card !== topCard && i > 0 && i <= stackPositions.length) {
          setCardPosition(card, stackPositions[i - 1]);
        }
      });
      setTimeout(() => {
        topCard.remove();
        currentIndex++;
        updateCounter();
        addCardToStack();
        const remainingCards = stack.querySelectorAll('.discover-card');
        if (remainingCards.length === 0) showEndState();
        isAnimating = false;
      }, 400);
    }

    function handleRead() {
      const topCard = getTopCard();
      if (!topCard) return;
      const link = topCard.dataset.link;
      if (link) window.open(link, '_blank', 'noopener,noreferrer');
    }

    nextBtn.addEventListener('click', handleNext);
    readBtn.addEventListener('click', handleRead);
    stack.addEventListener('click', (e) => {
      const card = e.target.closest('.discover-card');
      if (card && card === getTopCard()) handleRead();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') handleNext();
      if (e.key === 'Enter') handleRead();
    });
    updateStackPositions();
  </script>
</Base>

<style>
  .discover-main {
    max-width: 100%;
    padding: 0;
  }

  .stack-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem 2rem;
    min-height: 480px;
  }

  .stack {
    position: relative;
    width: 100%;
    max-width: 400px;
    height: 440px;
  }

  .card-count {
    margin-top: 1.5rem;
    font-size: 0.8rem;
    color: var(--ink-faint);
    font-variant-numeric: tabular-nums;
  }

  .discover-card {
    position: absolute;
    width: 100%;
    height: 100%;
    background: var(--bg);
    border: 1.5px solid var(--rule);
    padding: 2rem;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    transform-origin: center center;
    user-select: none;
    will-change: transform, opacity;
    overflow: hidden;
  }

  .dark .discover-card {
    background: var(--bg-soft);
  }

  .discover-card:not(:last-child) .discover-badge,
  .discover-card:not(:last-child) .discover-title,
  .discover-card:not(:last-child) .discover-excerpt,
  .discover-card:not(:last-child) .discover-meta {
    opacity: 0 !important;
    visibility: hidden;
    pointer-events: none;
  }

  .discover-card:not(:last-child) {
    background: var(--bg) !important;
  }

  .dark .discover-card:not(:last-child) {
    background: var(--bg-soft) !important;
  }

  .discover-card::after {
    content: '';
    position: absolute;
    top: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 48px;
    height: 14px;
    background: var(--bg-soft);
    border: 1px solid var(--rule);
    border-top: none;
    opacity: 0.7;
    z-index: 2;
  }

  .discover-card:not(:last-child)::after {
    display: none;
  }

  .discover-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--card-color);
  }

  .discover-badge {
    display: inline-flex;
    align-self: flex-start;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.2rem 0.5rem;
    border: 1.5px solid;
    margin-bottom: 1rem;
  }

  .discover-badge.tech { border-color: var(--tech); color: var(--tech); }
  .discover-badge.life { border-color: var(--life); color: var(--life); }
  .discover-badge.culture { border-color: var(--culture); color: var(--culture); }
  .discover-badge.design { border-color: var(--design); color: var(--design); }
  .discover-badge.finance { border-color: var(--finance); color: var(--finance); }
  .discover-badge.economics { border-color: var(--economics); color: var(--economics); }
  .discover-badge.history { border-color: var(--history); color: var(--history); }
  .discover-badge.psychology { border-color: var(--psychology); color: var(--psychology); }
  .discover-badge.philosophy { border-color: var(--philosophy); color: var(--philosophy); }
  .discover-badge.science { border-color: var(--science); color: var(--science); }

  .discover-title {
    font-family: var(--serif);
    font-size: 1.6rem;
    font-weight: 700;
    line-height: 1.2;
    letter-spacing: -0.02em;
    margin-bottom: 1rem;
  }

  .discover-excerpt {
    font-size: 0.92rem;
    line-height: 1.6;
    color: var(--ink-muted);
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
  }

  .discover-meta {
    margin-top: auto;
    padding-top: 1.25rem;
    border-top: 1px solid var(--rule);
  }

  .discover-author {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .author-name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .blog-hostname {
    font-size: 0.75rem;
    color: var(--ink-faint);
  }

  .discover-hint {
    text-align: center;
    padding: 1rem;
    color: var(--ink-faint);
    font-size: 0.78rem;
  }

  .discover-hint kbd {
    display: inline-block;
    padding: 0.2rem 0.4rem;
    background: var(--bg-soft);
    border: 1.5px solid var(--rule);
    font-family: inherit;
    font-size: 0.65rem;
    margin: 0 0.1rem;
  }

  .hint-sep {
    margin: 0 0.5rem;
    color: var(--rule);
  }

  .discover-actions {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 2rem 3rem;
  }

  .action-btn {
    height: 48px;
    border: 1.5px solid var(--rule);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    background: var(--bg);
    color: var(--ink-muted);
    font-family: var(--sans);
  }

  .action-btn:hover {
    border-color: var(--ink);
    color: var(--ink);
  }

  .action-btn.next {
    width: 48px;
    background: var(--bg-soft);
  }

  .action-btn.read {
    padding: 0 1.5rem;
    font-weight: 600;
    font-size: 0.75rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    gap: 0.5rem;
    background: var(--ink);
    border-color: var(--ink);
    color: var(--bg);
  }

  .action-btn.read:hover {
    opacity: 0.9;
  }

  .action-btn svg {
    width: 18px;
    height: 18px;
  }

  .end-state {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--ink-muted);
  }

  .end-state h3 {
    font-family: var(--serif);
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--ink);
  }

  .end-state p {
    margin-bottom: 1.5rem;
    font-size: 0.85rem;
  }

  .back-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.8rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .stack {
      max-width: 340px;
      height: 400px;
    }

    .stack-container {
      min-height: 440px;
      padding: 1rem;
    }

    .discover-title {
      font-size: 1.35rem;
    }

    .discover-card {
      padding: 1.5rem;
    }

    .discover-excerpt {
      -webkit-line-clamp: 3;
      font-size: 0.85rem;
    }

    .discover-actions {
      padding: 0.5rem 1.5rem 2rem;
    }
  }

  @media (max-width: 480px) {
    .stack-container {
      padding: 0.75rem;
      min-height: 400px;
    }

    .stack {
      max-width: 100%;
      height: 360px;
    }

    .discover-card {
      padding: 1.25rem;
    }

    .discover-title {
      font-size: 1.2rem;
      margin-bottom: 0.75rem;
    }

    .discover-badge {
      margin-bottom: 0.75rem;
    }

    .discover-excerpt {
      -webkit-line-clamp: 2;
      font-size: 0.8rem;
    }

    .discover-meta {
      padding-top: 0.75rem;
    }

    .discover-actions {
      padding: 0.5rem 1rem 2rem;
      gap: 0.75rem;
    }

    .action-btn { height: 42px; }
    .action-btn.next { width: 42px; }
    .action-btn.read { padding: 0 1.25rem; font-size: 0.7rem; }
    .action-btn svg { width: 16px; height: 16px; }

    .discover-hint {
      font-size: 0.7rem;
      padding: 0.75rem;
    }

    .card-count { font-size: 0.72rem; }
  }
</style>
