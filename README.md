# The Small Web

A curated feed of indie blogs. Hand-picked writing from independent voices who care about their craft.

## Overview

This project builds a static site (Astro) that displays an aggregated feed of posts from a curated list of RSS/Atom feeds. A scheduled job refreshes the feed data twice daily and commits the cache to the repo. The site is deployed to Cloudflare Workers with a static asset binding.

Key ideas:
- Manual curation via `data/blogs.json`
- Scheduled feed refresh via GitHub Actions
- Static site output served from Cloudflare Workers
- RSS proxy via Cloudflare Pages for Substack feeds

## Architecture

Data flow (high-level):

```
GitHub Actions (scripts/fetch-feeds.js)
    |-- Non-Substack feeds -> direct fetch (bounded parallel)
    |-- Substack feeds -> Cloudflare Pages proxy -> Substack (sequential + delay)
    |
    -> data/cache/posts.json
    -> data/cache/status.json

Astro build reads cached JSON
    -> dist/

Cloudflare Worker serves dist/ with security + cache headers
```

Hosting:
- Static site: Cloudflare Workers (assets binding to `dist/`)
- RSS proxy: Cloudflare Pages project (separate repo)

## Routes

Static routes generated by Astro:
- `/` main feed
- `/feed` chronological feed view
- `/archive` monthly archive
- `/blogs` blog directory
- `/discover` discovery UI
- `/about`
- `/status` feed health dashboard
- `/offline` offline fallback page
- `/rss.xml` site RSS

Dynamic routes:
- `/blog/[slug]` posts for a single blog
- `/category/[slug]` posts for a category

## Data model

`data/blogs.json`
```json
{
  "blogs": [
    {
      "id": "unique-slug",
      "name": "Blog Name",
      "url": "https://example.com",
      "feed": "https://example.com/rss.xml",
      "categories": ["tech"],
      "description": "Short description",
      "proxy": true
    }
  ]
}
```
- `proxy` is optional. Set to `true` for feeds that must use the proxy (e.g., Substack custom domains).

`data/cache/posts.json` (generated)
```json
{
  "lastUpdated": "2026-01-29T12:00:00Z",
  "posts": [
    {
      "id": "unique-post-id",
      "blogId": "unique-slug",
      "title": "Post Title",
      "link": "https://example.com/post",
      "date": "2026-01-29T00:00:00Z",
      "excerpt": "First 200-300 characters of content..."
    }
  ]
}
```

`data/cache/status.json` (generated)
```json
{
  "lastUpdated": "2026-01-29T12:00:00Z",
  "feeds": [
    {
      "blogId": "unique-slug",
      "status": "ok",
      "postCount": 10,
      "lastFetched": "2026-01-29T12:00:00Z",
      "latencyMs": 532,
      "error": null
    }
  ],
  "summary": {
    "total": 123,
    "healthy": 120,
    "errors": 3
  }
}
```

## Feed fetching pipeline

Entry point: `scripts/fetch-feeds.js`

Behavior:
- Uses `rss-parser` with a browser-like User-Agent.
- Non-Substack feeds are fetched in parallel with bounded concurrency.
- Substack feeds are fetched sequentially via a Cloudflare Pages proxy with a 30s delay between requests.
- For items without a snippet, it will fetch the article page and extract the first meaningful paragraph.
- Posts without a publish date are skipped.

Proxy rules:
- Substack feeds (`feed` contains `substack.com`) always go through the proxy.
- Set `"proxy": true` for custom-domain Substack feeds or any feed that needs the proxy.

Proxy endpoint:
- Default: `https://smallweb-rss.pages.dev/api/fetch-rss`
- Override with `PROXY_URL` env var

Tuning:
- `FEED_CONCURRENCY` (default: 8)
- `EXCERPT_CONCURRENCY` (default: 4)

Local run:
```bash
npm run fetch-feeds
```

## Deployment

GitHub Actions:
- `./.github/workflows/refresh-feeds.yml` refreshes feeds twice daily and commits cache updates.
- `./.github/workflows/deploy.yml` builds and deploys on push to `main`.

Cloudflare config:
- `wrangler.toml` binds `dist/` to Workers assets.
- Custom domains are configured in `wrangler.toml` routes.

Build output:
- `astro build` emits static files into `dist/`.

## Service worker and caching

`public/sw.js` provides offline caching:
- HTML: network-first with offline fallback
- Assets: cache-first

`worker/index.js` adds:
- Security headers for HTML responses
- Content-type based cache headers
- `no-cache` for `/sw.js` and `/manifest.json` to ensure updates are picked up promptly

## Local development

```bash
npm install
npm run dev
```

## Troubleshooting

Substack feeds returning 403:
- Ensure the feed is routed through the Cloudflare Pages proxy.
- For custom domains, add `"proxy": true` in `data/blogs.json`.

Slow or flaky feeds:
- Lower `FEED_CONCURRENCY` to reduce outbound load.
- Increase delays in `scripts/fetch-feeds.js` if needed.

Missing excerpts:
- Some sites block page scraping or have non-standard markup. These will fall back to empty excerpts.

## Repository layout

```
.
├── data/
│   ├── blogs.json
│   └── cache/
│       ├── posts.json
│       └── status.json
├── scripts/
│   └── fetch-feeds.js
├── src/
│   ├── pages/
│   ├── components/
│   ├── layouts/
│   └── styles/
├── public/
│   ├── sw.js
│   └── manifest.json
├── worker/
│   └── index.js
├── wrangler.toml
└── astro.config.mjs
```
